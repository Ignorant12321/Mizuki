---
/*
 * Live2D Widget (Based on stevenjoezhang/live2d-widget)
 *
 */

import { live2dConfig } from "../../config";

// // 如果配置关闭，则不渲染
if (!live2dConfig.enable) {
	return;
}

const { drag, modelId, logLevel, tools } = live2dConfig;
const live2dPath =
	live2dConfig.live2dPath ||
	"https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0-rc.6/dist/";
const waifuPath =
	live2dConfig.waifuPath ||
	"https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0-rc.6/dist/live2d/waifu-tips.json";
---

<div id="waifu">
	<div id="waifu-tips"></div>
	<canvas id="live2d" width="800" height="800"></canvas>
	<div id="waifu-tool"></div>
</div>
<link rel="stylesheet" href={live2dPath + "waifu.css"} />
<script is:inline define:vars={{ config: live2dConfig, live2dPath, waifuPath }}>
	// 封装资源加载
	function loadExternalResource(url, type) {
		return new Promise((resolve, reject) => {
			let tag;
			if (type === "css") {
				tag = document.createElement("link");
				tag.rel = "stylesheet";
				tag.href = url;
			} else if (type === "js") {
				tag = document.createElement("script");
				tag.type = "module";
				tag.src = url;
			}
			if (tag) {
				tag.onload = () => resolve(url);
				tag.onerror = () => reject(url);
				document.head.appendChild(tag);
			}
		});
	}

	(async () => {
		// 屏幕宽度小于768不渲染;
		// if (screen.width < 768) return;

		// 避免图片资源跨域问题
		const OriginalImage = window.Image;
		window.Image = function (...args) {
			const img = new OriginalImage(...args);
			img.crossOrigin = "anonymous";
			return img;
		};
		if (typeof window.initWidget !== "function") {
			console.log("Live2D 脚本未检测到，正在首次加载 waifu-tips.js ...");
			await loadExternalResource(live2dPath + "waifu-tips.js", "js");
			initWidget({
				waifuPath: waifuPath,
				cdnPath: "https://fastly.jsdelivr.net/gh/fghrsh/live2d_api/",
				cubism2Path:
					"https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0-rc.6/dist/live2d.min.js",
				cubism5Path:
					"https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js",
				tools: config.tools,
				modelId: config.modelId,
				logLevel: config.logLevel,
				drag: config.drag,
			});
		} else {
			return;
		}
	})();

	const canvas = document.getElementById("live2d");
	if (canvas) {
		canvas.addEventListener(
			"wheel",
			(e) => {
				e.stopImmediatePropagation();
			},
			{ passive: true, capture: true },
		);
	}
</script>
<style is:global>
	@media (max-width: 768px), (hover: none) {
		#waifu-toggle.waifu-toggle-active {
			margin-left: -30px !important;
		}
		#waifu-tool {
			opacity: 1 !important;
		}
	}
	#waifu,
	#waifu-tool,
	#waifu-toggle {
		z-index: 99 !important;
	}
	#waifu {
		left: auto !important;
		right: 1.5rem !important;
	}
	/* 将 waifu-toggle 固定到右侧 */
	#waifu-toggle {
		left: auto !important;
		right: 0 !important;
		transform: rotateY(180deg);
		margin-right: -100px;
		transition: margin-right 1s;
	}

	/* 从右侧滑入/滑出的过渡效果 */
	#waifu-toggle.waifu-toggle-active {
		margin-right: -45px !important;
	}
	#waifu-toggle:hover {
		margin-right: -35px !important;
	}

	/* 移动端也保持右侧行为 */
	@media (max-width: 768px), (hover: none) {
		#waifu-toggle.waifu-toggle-active {
			margin-right: -30px !important;
			margin-left: 0 !important;
		}
	}
</style>
