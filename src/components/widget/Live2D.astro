---
/*
 * Live2D Widget (Based on stevenjoezhang/live2d-widget)
 * 修复：防止进入文章页后按钮重复出现 + 支持位置锁定
 */
import { live2dConfig } from "../../config";

// 如果配置关闭，则不渲染
if (!live2dConfig.enable) {
	return;
}

const { position, lock, size, offset, tips, tools } = live2dConfig;

// 格式化函数
const formatSize = (val: string | number | undefined) => {
	if (val === "" || val === undefined || val === null) return "auto";
	return typeof val === "number" ? `${val}px` : val;
};

// 悬浮抬高高度 (默认 -20px)
const hoverOffset = offset.hover !== undefined ? offset.hover : "-20px";
---

<div
	id="waifu"
	class={position === "left" ? "waifu-left" : "waifu-right"}
	style={{
		"--waifu-width": formatSize(size.width),
		"--waifu-height": formatSize(size.height),
		"--waifu-bottom": offset.bottom,
		"--waifu-side": offset.side,
		"--waifu-hover": hoverOffset,
		"--tips-top": tips.top,
		"--tips-width": formatSize(tips.width),
		"--tools-top": tools.top,
		"--tools-side": tools.side,
	}}
>
	<div id="waifu-tips"></div>
	<canvas id="live2d" width="800" height="800"></canvas>

	<div id="waifu-tool"></div>
</div>

<link rel="stylesheet" href={`${live2dConfig.cdnPath}waifu.css`} />
<link
	rel="stylesheet"
	href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.2/css/all.min.css"
/>

<script is:inline define:vars={{ config: live2dConfig }}>
	// 封装资源加载
	function loadExternalResource(url, type) {
		return new Promise((resolve, reject) => {
			// 防止重复加载 CSS
			if (
				type === "css" &&
				document.querySelector(`link[href="${url}"]`)
			) {
				resolve();
				return;
			}
			let tag;
			if (type === "css") {
				tag = document.createElement("link");
				tag.rel = "stylesheet";
				tag.href = url;
			} else if (type === "js") {
				tag = document.createElement("script");
				tag.type = "module";
				tag.src = url;
			}
			if (tag) {
				tag.onload = () => resolve(url);
				tag.onerror = () => reject(url);
				document.head.appendChild(tag);
			}
		});
	}

	(async () => {
		if (
			!config.mobile.show &&
			window.innerWidth < config.mobile.breakpoint
		) {
			return;
		}

		await loadExternalResource(config.cdnPath + "waifu-tips.js", "js");

		if (typeof initWidget === "function") {
			// 【关键修复】初始化前先清空工具栏，防止页面切换时重复添加按钮
			const toolDiv = document.getElementById("waifu-tool");
			if (toolDiv) toolDiv.innerHTML = "";

			initWidget({
				waifuPath: config.cdnPath + "waifu-tips.json",
				cubism2Path: config.cdnPath + "live2d.min.js",
				cubism5Path: config.cdnPath + "live2dcubismcore.min.js",
				tools: config.tools.items,

				// 【关键】这里配置是否允许拖拽
				// 如果 config.lock 为 true，则 drag 为 false (取反)
				drag: !config.lock,

				logLevel: "warn",
			});
		}
	})();

	const canvas = document.getElementById("live2d");
	if (canvas) {
		canvas.addEventListener(
			"wheel",
			(e) => {
				e.stopImmediatePropagation();
			},
			{ passive: true, capture: true },
		);
	}
</script>

<style>
	/* --- 看板娘主体 --- */
	#waifu {
		position: fixed;
		z-index: 9999;
		width: var(--waifu-width);
		height: var(--waifu-height);
		display: block;
		pointer-events: none;
		transition: transform 0.3s ease-in-out;
	}

	/* 悬浮抬高 (配合 config.offset.hover) */
	#waifu:hover {
		transform: translateY(var(--waifu-hover)) !important;
	}

	#live2d,
	#waifu-tool,
	#waifu-tips {
		pointer-events: auto;
	}

	/* --- 位置修正 --- */

	/* 看板娘在左边 */
	#waifu.waifu-left {
		left: var(--waifu-side);
		right: auto;
		bottom: var(--waifu-bottom);
	}

	/* 看板娘在右边 */
	#waifu.waifu-right {
		right: var(--waifu-side);
		left: auto;
		bottom: var(--waifu-bottom);
	}

	/* 画布限制 */
	#live2d {
		width: var(--waifu-width) !important;
		height: var(--waifu-height) !important;
		position: relative;
	}

	/* 气泡框 */
	#waifu-tips {
		top: var(--tips-top) !important;
		width: var(--tips-width) !important;
	}

	#waifu-tool {
		top: var(--tools-top) !important;
	}

	/* --- 按钮跟随 --- */
	.waifu-left #waifu-tool {
		left: auto !important;
		right: var(--tools-side) !important;
	}

	.waifu-right #waifu-tool {
		right: auto !important;
		left: var(--tools-side) !important;
	}
</style>
