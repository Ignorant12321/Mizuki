---
import { siteConfig } from "../config";
import { getDiaryList, getDiaryStats } from "../data/diary";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

if (!siteConfig.featurePages.diary) {
	return Astro.redirect("/404/");
}

const moments = await getDiaryList();
const diaryStats = await getDiaryStats();

// Ê†ºÂºèÂåñÊó•Êúü‰∏∫ YYYY.MM.DD
function formatDateSimple(dateString: string): string {
	const date = new Date(dateString);
	const y = date.getFullYear();
	const m = String(date.getMonth() + 1).padStart(2, "0");
	const d = String(date.getDate()).padStart(2, "0");
	return `${y}.${m}.${d}`;
}

function formatTimeAgo(dateString: string): string {
	const timeGap =
		siteConfig.timeZone >= -12 && siteConfig.timeZone <= 12
			? siteConfig.timeZone
			: 8;
	const diffInMinutes = Math.floor(
		(new Date().getTime() +
			timeGap * 60 * 60 * 1000 -
			new Date(dateString).getTime()) /
			60000,
	);

	if (diffInMinutes < 60)
		return `${diffInMinutes} ${i18n(I18nKey.diaryMinutesAgo)}`;
	if (diffInMinutes < 1440)
		return `${Math.floor(diffInMinutes / 60)} ${i18n(I18nKey.diaryHoursAgo)}`;
	return `${Math.floor(diffInMinutes / 1440)} ${i18n(I18nKey.diaryDaysAgo)}`;
}
---

<MainGridLayout title={i18n(I18nKey.diary)} description="Âç≥ÂàªÁü≠Êñá">
	<script>
		import("../scripts/right-sidebar-layout.js");
	</script>
	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div
			class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full bg-[var(--page-bg)]"
		>
			<div class="relative max-w-3xl w-full mx-auto px-2 md:px-0">
				<div class="moments-header mb-8 mx-auto max-w-2xl">
					<div
						class="header-content text-center md:text-left relative z-10"
					>
						<div>
							<h1
								class="text-2xl md:text-3xl font-bold text-white mb-2"
							>
								{i18n(I18nKey.diary)}
							</h1>
							<p class="text-sm md:text-base text-white/80">
								{i18n(I18nKey.diarySubtitle)}
							</p>
						</div>
						<div
							class="mt-4 md:mt-0 md:absolute md:right-0 md:top-1/2 md:-translate-y-1/2"
						>
							<div
								class="inline-flex flex-col items-center bg-white/10 rounded-lg px-4 py-2 backdrop-blur-sm"
							>
								<span
									class="text-xl md:text-2xl font-bold text-white"
									>{diaryStats.total}</span
								>
								<span class="text-xs text-white/70"
									>{i18n(I18nKey.diaryCount)}</span
								>
							</div>
						</div>
					</div>
					<div
						class="absolute inset-0 bg-gradient-to-br from-[var(--primary)] to-[var(--primary-dark)] opacity-90 mix-blend-multiply"
					>
					</div>
					<div
						class="absolute -bottom-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"
					>
					</div>
				</div>

				<div class="moments-timeline relative z-10">
					<div
						class="absolute left-4 md:left-0 top-4 bottom-4 w-0.5 bg-[var(--line-divider)] opacity-50 hidden md:block"
					>
					</div>

					<div class="timeline-list space-y-8">
						{
							moments.map((moment, index) => {
								const imageCount = moment.images?.length || 0;

								// ‰øÆÂ§çÂØπÈΩêÔºöÂçïÂõæÂä† flex justify-centerÔºåÂ§öÂõæÂä† mx-auto Â±Ö‰∏≠
								let gridClass =
									"diary-images mt-4 gap-2 md:gap-3";
								if (imageCount === 1)
									gridClass += " flex justify-center";
								else if (imageCount === 2 || imageCount === 4)
									gridClass +=
										" grid grid-cols-2 max-w-[400px] mx-auto";
								else
									gridClass +=
										" grid grid-cols-3 max-w-[500px] mx-auto";

								return (
									<div class="moment-item relative pl-0 md:pl-8 group">
										<div class="absolute left-0 top-5 w-2 h-2 rounded-full bg-[var(--primary)] ring-4 ring-[var(--page-bg)] hidden md:block" />

										<div class="card-base-daily rounded-[var(--radius-large)] bg-[var(--card-bg)] transition-all hover:shadow-xl overflow-hidden">
											<div class="moment-header flex items-center justify-between px-5 pt-5 pb-3 md:px-7 md:pt-6">
												<div class="flex items-baseline gap-2">
													<span class="text-lg md:text-xl font-bold text-[var(--text-main)] font-mono tracking-tight">
														{formatDateSimple(
															moment.date,
														)}
													</span>
												</div>
												<time
													datetime={moment.date}
													class="text-xs md:text-sm text-[var(--text-muted)] whitespace-nowrap"
												>
													{formatTimeAgo(moment.date)}
												</time>
											</div>

											<div class="moment-content px-5 md:px-7 pb-4">
												<p class="text-base md:text-[1.05rem] text-[var(--text-main)] leading-relaxed whitespace-pre-wrap">
													{moment.content}
												</p>

												{imageCount > 0 && (
													<div class={gridClass}>
														{moment.images!.map(
															(image) => {
																const isSingle =
																	imageCount ===
																	1;
																const imgWrapperClass =
																	isSingle
																		? "image-item relative rounded-lg overflow-hidden cursor-pointer bg-[var(--card-bg-alt)] max-h-[400px] w-auto inline-block shadow-sm"
																		: "image-item relative rounded-lg overflow-hidden cursor-pointer bg-[var(--card-bg-alt)] aspect-square w-full shadow-sm";

																return (
																	<div
																		class={
																			imgWrapperClass
																		}
																	>
																		<a
																			href="javascript:void(0)"
																			data-src={
																				image
																			}
																			data-fancybox={`gallery-${index}`}
																			class={`block ${isSingle ? "h-full w-auto" : "w-full h-full"}`}
																		>
																			<img
																				src={
																					image
																				}
																				alt="diary moment"
																				class={`w-full h-full transition-transform duration-500 group-hover:scale-105 ${isSingle ? "object-contain" : "object-cover"}`}
																				loading="lazy"
																			/>
																		</a>
																	</div>
																);
															},
														)}
													</div>
												)}
											</div>

											{(moment.location ||
												moment.mood ||
												(moment.tags &&
													moment.tags.length >
														0)) && (
												<div class="moment-footer px-5 py-3 md:px-7 bg-[var(--card-bg-alt)]/50 border-t border-[var(--line-divider)]/50 flex flex-wrap items-center justify-between gap-y-2 text-xs md:text-sm text-[var(--text-muted)]">
													<div class="flex flex-wrap items-center gap-4 mr-auto">
														{moment.location && (
															<div
																class="flex items-center gap-1 shrink-0"
																title={
																	moment.location
																}
															>
																<i class="text-[var(--primary)] opacity-80">
																	üìç
																</i>
																<span class="truncate max-w-[150px] md:max-w-[200px]">
																	{
																		moment.location
																	}
																</span>
															</div>
														)}
														{moment.mood && (
															<div class="flex items-center gap-1 shrink-0">
																<i class="opacity-80">
																	üí≠
																</i>
																<span>
																	{
																		moment.mood
																	}
																</span>
															</div>
														)}
													</div>

													{moment.tags &&
														moment.tags.length >
															0 && (
															<div class="flex flex-wrap items-center gap-x-3 gap-y-1 ml-auto pl-4">
																{moment.tags.map(
																	(tag) => (
																		<span class="inline-flex items-center text-[var(--text-muted)] hover:text-[var(--primary)] transition-colors">
																			<span class="opacity-50 mr-0.5">
																				#
																			</span>
																			{
																				tag
																			}
																		</span>
																	),
																)}
															</div>
														)}
												</div>
											)}
										</div>
									</div>
								);
							})
						}
					</div>
				</div>

				<div
					class="moments-tips text-center mt-12 mb-8 text-[var(--text-muted)] text-xs md:text-sm opacity-80"
				>
					‚Äî‚Äî {i18n(I18nKey.diaryTips)} ‚Äî‚Äî
				</div>
			</div>
		</div>
	</div>
</MainGridLayout>

<style>
	.card-base-daily {
		box-shadow:
			0 2px 8px -2px rgba(0, 0, 0, 0.05),
			0 0 1px rgba(0, 0, 0, 0.1);
	}
	.card-base-daily:hover {
		box-shadow:
			0 8px 16px -4px rgba(0, 0, 0, 0.1),
			0 0 1px rgba(0, 0, 0, 0.1);
		transform: translateY(-2px);
	}

	.moments-header {
		padding: 2rem;
		border-radius: 16px;
		position: relative;
		overflow: hidden;
		background-color: var(--primary);
	}

	@media (max-width: 768px) {
		.moments-header {
			padding: 1.5rem;
		}
		.moment-footer {
			align-items: flex-start;
		}
		.moment-footer > div.ml-auto {
			margin-left: 0;
			padding-left: 0;
			margin-top: 0.5rem;
			width: 100%;
		}
	}
</style>
