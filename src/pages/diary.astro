---
import { siteConfig } from "../config";
import { getDiaryList, getDiaryStats } from "../data/diary";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// æ£€æŸ¥æ—¥è®°é¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.featurePages.diary) {
	return Astro.redirect("/404/");
}

// è·å–æ—¥è®°æ•°æ®
const moments = await getDiaryList();
const diaryStats = await getDiaryStats();

// æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatTime(dateString: string): string {
	var TG = 8;
	if (siteConfig.timeZone >= -12 && siteConfig.timeZone <= 12)
		TG = siteConfig.timeZone;
	const timeGap = TG;

	const now = new Date();
	const date = new Date(dateString);
	const diffInMinutes = Math.floor(
		(now.getTime() + timeGap * 60 * 60 * 1000 - date.getTime()) /
			(1000 * 60),
	);
	if (diffInMinutes < 60) {
		return `${diffInMinutes}${i18n(I18nKey.diaryMinutesAgo)}`;
	}
	if (diffInMinutes < 1440) {
		// 24å°æ—¶
		const hours = Math.floor(diffInMinutes / 60);
		return `${hours}${i18n(I18nKey.diaryHoursAgo)}`;
	}
	const days = Math.floor(diffInMinutes / 1440);
	return `${days}${i18n(I18nKey.diaryDaysAgo)}`;
}
---

<MainGridLayout title={i18n(I18nKey.diary)} description="å³åˆ»çŸ­æ–‡">
	<script>
		import("../scripts/right-sidebar-layout.js");
	</script>
	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
			<div class="relative max-w-4xl w-full px-2 md:px-0">
				<div class="moments-header mb-6">
					<div class="header-content">
						<div class="header-info">
							<h1
								class="moments-title text-xl md:text-2xl lg:text-3xl font-bold text-90 mb-1"
							>
								{i18n(I18nKey.diary)}
							</h1>
							<p
								class="moments-subtitle text-sm md:text-base lg:text-lg text-75"
							>
								{i18n(I18nKey.diarySubtitle)}
							</p>
						</div>
						<div class="header-stats">
							<div class="stat-item text-center">
								<span
									class="stat-number text-lg md:text-xl lg:text-2xl font-bold text-[var(--primary)]"
									>{diaryStats.total}</span
								>
								<span
									class="stat-label text-xs md:text-sm lg:text-base text-75"
									>{i18n(I18nKey.diaryCount)}</span
								>
							</div>
						</div>
					</div>
				</div>

				<div class="moments-timeline">
					<div class="timeline-list space-y-4">
						{
							moments.map((moment, index) => {
								const imageCount = moment.images
									? moment.images.length
									: 0;

								// åŠ¨æ€è®¡ç®—å›¾ç‰‡å®¹å™¨æ ·å¼
								// 1å¼ å›¾: Flexå¸ƒå±€ï¼Œé å·¦
								// 2æˆ–4å¼ å›¾: 2åˆ— Grid
								// å…¶ä»–(3, 5+): 3åˆ— Grid
								let gridClassName =
									"diary-images mt-3 md:mt-4 gap-2 md:gap-3";
								if (imageCount === 1) {
									gridClassName += " flex justify-center";
								} else if (
									imageCount === 2 ||
									imageCount === 4
								) {
									gridClassName +=
										" grid grid-cols-2 max-w-[80%] md:max-w-[60%] mx-auto";
								} else {
									gridClassName +=
										" grid grid-cols-3 mx-auto";
								}

								return (
									<div class="moment-item card-base-daily p-4 md:p-6 lg:p-8 hover:shadow-lg transition-all group">
										<div class="moment-content">
											{/* æ­£æ–‡ */}
											<p class="moment-text text-sm md:text-base lg:text-lg text-90 leading-relaxed mb-3 md:mb-4">
												{moment.content}
											</p>

											{/* å›¾ç‰‡æ¸²æŸ“ */}
											{imageCount > 0 && (
												<div class={gridClassName}>
													{moment.images &&
														moment.images.map(
															(image, _index) => {
																const isSingle =
																	imageCount ===
																	1;
																// å•å›¾ï¼šé™åˆ¶æœ€å¤§é«˜åº¦ï¼Œä¿ç•™æ¯”ä¾‹
																// å¤šå›¾ï¼šå¼ºåˆ¶æ­£æ–¹å½¢ (aspect-square)
																const imgWrapperClass =
																	isSingle
																		? "image-item relative rounded-lg overflow-hidden cursor-pointer border border-[var(--line-divider)] max-h-[500px] w-auto inline-block"
																		: "image-item relative rounded-lg overflow-hidden cursor-pointer aspect-square w-full";

																return (
																	<div
																		class={
																			imgWrapperClass
																		}
																	>
																		<a
																			href="javascript:void(0)"
																			data-src={
																				image
																			}
																			data-fancybox={`gallery-${index}`}
																			class={
																				isSingle
																					? "block h-full w-auto"
																					: "block w-full h-full"
																			}
																		>
																			<img
																				src={
																					image
																				}
																				alt="diary moment image"
																				class={`w-full h-full transition-transform duration-300 hover:scale-105 ${isSingle ? "object-contain bg-black/5" : "object-cover"}`}
																				loading="lazy"
																			/>
																		</a>
																	</div>
																);
															},
														)}
												</div>
											)}

											{/* æ ‡ç­¾ (å³å¯¹é½) */}
											{moment.tags &&
												moment.tags.length > 0 && (
													<div class="moment-tags flex flex-wrap justify-end gap-2 mb-3 mt-4">
														{moment.tags.map(
															(tag) => (
																<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[var(--bg-tag,rgba(0,0,0,0.05))] text-[var(--text-tag,#666)] transition-colors hover:bg-[var(--bg-tag-hover,rgba(0,0,0,0.1))]">
																	# {tag}
																</span>
															),
														)}
													</div>
												)}
										</div>

										{/* åˆ†å‰²çº¿ */}
										<hr class="moment-divider border-t border-[var(--line-divider)] my-3 md:my-4 opacity-60" />

										{/* åº•éƒ¨ Meta ä¿¡æ¯æ  */}
										<div class="moment-footer flex items-center justify-between w-full text-xs md:text-sm text-75">
											{/* å·¦ä¾§ï¼šåœ°ç‚¹ä¸å¿ƒæƒ… */}
											<div class="flex items-center gap-2 md:gap-4 min-w-0 overflow-hidden mr-2">
												{/* åœ°ç‚¹ */}
												{moment.location && (
													<div
														class="moment-location flex items-center gap-1 text-75 hover:text-main transition-colors min-w-0"
														title={moment.location}
													>
														<i class="location-icon text-main opacity-80 shrink-0">
															ğŸ“
														</i>
														<span class="truncate">
															{moment.location}
														</span>
													</div>
												)}

												{/* å¿ƒæƒ… */}
												{moment.mood && (
													<div class="moment-mood flex items-center gap-1 text-75 shrink-0">
														<i class="mood-icon opacity-80">
															ğŸ’­
														</i>
														<span class="hidden md:inline">
															{moment.mood}
														</span>
													</div>
												)}
											</div>

											{/* å³ä¾§ï¼šæ—¶é—´ */}
											<div class="moment-time flex items-center gap-1.5 opacity-80 group-hover:opacity-100 transition-opacity shrink-0 ml-auto">
												<time
													datetime={moment.date}
													class="font-mono whitespace-nowrap"
												>
													{moment.date.substring(
														0,
														10,
													)}
													({formatTime(moment.date)})
												</time>
												<i class="time-icon text-[10px] md:text-xs">
													ğŸ•
												</i>
											</div>
										</div>
									</div>
								);
							})
						}
					</div>
				</div>

				<div
					class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic"
				>
					{i18n(I18nKey.diaryTips)}
				</div>
			</div>
		</div>
	</div>
</MainGridLayout>

<style>
	.card-base-daily {
		@apply rounded-[var(--radius-large)] overflow-hidden bg-[var(--card-bg)];
		border: 1px solid var(--line-divider);
		transition: all 0.3s ease;
	}

	.moments-header {
		padding: 1rem;
		border-radius: 8px;
		background: linear-gradient(
			135deg,
			var(--primary) 0%,
			var(--primary-dark, var(--primary)) 100%
		);
		color: white;
		position: relative;
		overflow: hidden;
	}

	.header-content {
		display: flex;
		justify-content: space-between;
		align-items: center;
		position: relative;
		z-index: 1;
	}

	.moments-title {
		color: white;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
	}

	.moments-subtitle {
		color: rgba(255, 255, 255, 0.9);
	}

	.stat-number {
		color: white;
	}

	.stat-label {
		color: rgba(255, 255, 255, 0.8);
	}

	.image-item img {
		/* transition moved to tailwind class to handle different cases */
	}

	.action-btn {
		background: none;
		border: none;
		cursor: pointer;
		color: var(--text-muted);
	}

	.action-btn:hover {
		color: var(--primary);
	}

	/* å“åº”å¼è®¾è®¡ */
	/* æ‰‹æœºç«¯ (å°äº640px) */
	@media (max-width: 640px) {
		.moments-header {
			padding: 0.75rem;
		}

		.header-content {
			flex-direction: column;
			text-align: center;
			gap: 0.75rem;
		}

		.moment-footer {
			flex-direction: column;
			align-items: flex-start;
			gap: 0.5rem;
		}
	}

	/* å¹³æ¿ç«–å± (641px - 900px) */
	@media (min-width: 641px) and (max-width: 900px) {
		.moments-header {
			padding: 1.25rem;
		}

		.header-content {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.moment-item {
			padding: 1.5rem;
		}

		.moment-text {
			font-size: 1rem;
			line-height: 1.7;
		}

		.moment-footer {
			margin-top: 1rem;
		}
	}

	/* å¹³æ¿æ¨ªå±å’Œæ¡Œé¢ç«¯ (å¤§äº900px) */
	@media (min-width: 901px) {
		.moments-header {
			padding: 1.5rem;
		}

		.moment-item {
			padding: 2rem;
		}

		.moment-text {
			font-size: 1.1rem;
			line-height: 1.8;
		}
	}

	/* ä¼˜åŒ–å°å±å¹•æ˜¾ç¤º */
	@media (max-width: 480px) {
		.moment-item {
			border-radius: 8px;
		}

		.moments-header {
			border-radius: 6px;
		}
	}
</style>
